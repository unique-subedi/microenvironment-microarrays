---
title: "aaron"
output: html_document
date: "2022-09-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tools)
library(psych)
```

```{r read_data, cache=TRUE, echo=FALSE, message=FALSE}
rm(list = ls())
walk(
  dir("Data/", full.names = TRUE),
  function(file) {
    assign(file_path_sans_ext(basename(file)), read_tsv(file), .GlobalEnv)
  }
)
tbls <- as.list.environment(.GlobalEnv, sorted = TRUE)
```

Position on the plate seems to affect cell count as evidenced by splotches of low or NA (0?) cell count. Might want to account for this somehow.

```{r, fig.width=12, fig.height=10}
# Spot_PA_SpotCellCount
for(i in seq_along(tbls)){
  print(tbls[[i]] %>%
    ggplot(aes(ArrayColumn, ArrayRow, fill = Spot_PA_SpotCellCount)) +
    facet_wrap(vars(WellIndex, Ligand1)) +
    geom_tile() +
    labs(fill = "Cell Count", title = i) +
    theme_bw()
  )
}
```

```{r, fig.width=12, fig.height=10}
# Spot_PA_SpotCellCount
for(i in 1:8){
  print(tbls[[i]] %>%
    ggplot(aes(ArrayColumn, ArrayRow, fill = Cells_CP_AreaShape_Area)) +
    facet_wrap(vars(WellIndex, Ligand1)) +
    geom_tile() +
    labs(fill = "Cells_CP_AreaShape_Area", title = i) +
    theme_bw()
  )
}
```

Cell count summary stats.

```{r}
cell_ct_summary = sapply(tbls, function(x) 
    summary(x$Spot_PA_SpotCellCount)
  ) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "plate")
cell_ct_summary
```

Median cell count highest for staining set 3. 

```{r}
lapply(seq_along(tbls), function(x)
  data.frame(plate = x, ct = tbls[[x]]$Spot_PA_SpotCellCount)
) %>%
  bind_rows() -> ct_df

ggplot(ct_df, mapping = aes(x = as.factor(plate), y = ct)) + 
  geom_boxplot() + 
  xlab("Plate number") + 
  ylab("Cell count")

ggplot(ct_df, mapping = aes(x = as.factor(plate), y = ct)) + 
  geom_violin() + 
  xlab("Plate number") + 
  ylab("Cell count")
```

Average cell counts grouped by stain/ecmp/ligand.

```{r}
lapply(seq_along(tbls), function(x)
  data.frame(stain = ceiling(x/8),
             ecmp = tbls[[x]]$ECMp,
             ligand = tbls[[x]]$Ligand1,
             ct = tbls[[x]]$Spot_PA_SpotCellCount)
)  %>%
  bind_rows() %>%
  group_by(stain, ecmp, ligand) %>%
  summarise(mean = mean(ct), median = median(ct)) %>%
  arrange(mean) -> ct_sel_summary_df
head(ct_sel_summary_df)
tail(ct_sel_summary_df)
```

Average cell counts grouped by stain/ligand.

```{r}
lapply(seq_along(tbls), function(x)
  data.frame(stain = ceiling(x/8),
             ecmp = tbls[[x]]$ECMp,
             ligand = tbls[[x]]$Ligand1,
             ct = tbls[[x]]$Spot_PA_SpotCellCount)
)  %>%
  bind_rows() %>%
  group_by(stain, ligand) %>%
  summarise(mean = mean(ct), median = median(ct)) %>%
  arrange(mean) -> ct_sl_summary_df
ct_sl_summary_df
```

```{r Big Spearman correlation tibble}
cor_tbl_list = vector(mode = "list", length = length(tbls))
for(i in seq_along(cor_tbl_list)){
  tbls2 = tbls[[i]] %>%
  unite(ECM1, Ligand1, col = "treatment", sep = ":")
  treatments = tbls2[["treatment"]]
  
  tbls_reduced = tbls[[i]] %>%
    select(!(WellIndex:PinDiameter)) %>%
    select(where(is.numeric)) %>%
    select(where(function(x) length(unique(x)) > 8)) %>%
    mutate(treatment = treatments) %>%
    select(treatment, everything()) %>%
    select(!PrintSpot & !ImageID & !ClarionID) %>%
    select(Nuclei_CP_AreaShape_Area | !contains("_AreaShape_")) %>%
    select(!contains("_90_") | !ends_with("_90")) %>%
    select(!contains("_IntegratedIntensity"))
    
  cor_list = vector(mode = "list", length = length(unique(treatments)))
  names(cor_list) = unique(treatments)
  for(j in seq_along(cor_list)){
    treat_tbl = tbls_reduced %>% 
      filter(treatment == unique(treatments)[[j]]) %>%
      select(!treatment) %>%
      select(where(function(x) length(unique(x)) > 1))
    if(length(treat_tbl) != 0){
      cor_test_out = corr.test(treat_tbl, method = "spearman", ci = FALSE)
      p_mat_simple = cor_test_out[["p"]]
      p_mat_simple[upper.tri(p_mat_simple)] = 2 # Filters out repeats later
      p_tbl = p_mat_simple %>%
        as.data.frame() %>%
        rownames_to_column(var = "row_var") %>%
        pivot_longer(names_to = "col_var", cols = !matches("row_var")) %>%
        rename(p_val = value)
      cor_list[[j]] = cor_test_out[["r"]] %>%
        as.data.frame() %>%
        rownames_to_column(var = "row_var") %>%
        pivot_longer(names_to = "col_var", cols = !matches("row_var")) %>%
        rename(spear_cor = value) %>%
        left_join(p_tbl, by = c("row_var", "col_var")) %>%
        filter(p_val <= 1, row_var != col_var) %>%
        mutate(treatment = names(cor_list)[[j]], table_num = i) %>%
        select(table_num, treatment, everything()) %>%
        separate(treatment, into = c("ECM1", "Ligand1"), sep = ":", 
                 remove = FALSE)
    }
  }
  cor_tbl_list[[i]] = bind_rows(cor_list)
}
big_cor_tbl = bind_rows(cor_tbl_list) %>%
  arrange(p_val)

small_big_cor_tbl = big_cor_tbl %>%
  mutate(row_num = 1:nrow(big_cor_tbl)) %>%
  mutate(pass_holm = p_val <= 0.01/(nrow(big_cor_tbl) - row_num + 1)) %>%
  filter(pass_holm == TRUE) %>%
  select(!row_num & !pass_holm)

# write_tsv(small_big_cor_tbl, "small_big_cor_tbl.tsv")  
```








